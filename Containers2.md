# Урок 2. Механизмы контрольных групп
## Информация о проекте
### Задание 1:

* запустить контейнер с ubuntu, используя механизм LXC;
ограничить контейнер 256 Мб ОЗУ и проверить, что ограничение работает;
добавить автозапуск контейнеру, перезагрузить ОС и убедиться, что контейнер действительно запустился самостоятельно;
при создании указать файл, куда записывать логи;
после перезагрузки проанализировать логи.
* Задание 2*: настроить автоматическую маршрутизацию между контейнерами. Адреса можно взять: 10.0.12.0/24 и 10.0.13.0/24.

* Задание со звездочкой - повышенной сложности, это нужно учесть при выполнении (но сделать его необходимо). 

* ИЛИ создать несколько процессов и вручную распределить их по разным контрольным группам ограничив различные ресурсы как на семинаре.

### Задание

* Установим LXC и шаблоны:

sudo apt install lxc lxc-templates uidmap

* Затем командой "$ lxc version" проверяем уствновленную версию. Видим как система подсказывает, что для начала необходимо инициализировать LXD на машине. Вводим команду:

lxd init

* После инициализации снова убеждаемся, что все нормально установлено, путем проверки версии LXC:

lxc version


![1.jpg](..%2F..%2F..%2FDesktop%2FContainers2%2F1.jpg)

* Следующей командой создаем новый контейнер с именем testOne и задаем путь для файла конфигурации:

lxc-create -n testOne -t ubuntu -f /usr/share/doc/lxc/lxc-veth.conf 

* Видим большое количество текста, значит команда введена правильно. В тексте указана ошибка открытия файла конфигурации указанного нами. На запуск контейнера это не повлияет, а случается из=за того, что такого файла на данном этапе не существует.

![2.jpg](..%2F..%2F..%2FDesktop%2FContainers2%2F2.jpg)

* После того, как контейнер установился мы видим следующий текст:


![3.jpg](..%2F..%2F..%2FDesktop%2FContainers2%2F3.jpg)

#### Система оповещает нас о том, что контейнер создан, у него заданы стандартные параметры (логин: ubuntu, пароль: ubuntu).

* Теперь необходимо запустить созданный нами контейнер. Для этого вводим следующую команду:

sudo lxc-start -d -n testOne![4.jpg](..%2F..%2F..%2FDesktop%2FContainers2%2F4.jpg)

#### Если ситема никак не оповестила нас ни о чем, значит команда успешно выполнена. Проверить это можно, например, путем входа в контейнер:

sudo lxc-attach -n testOne
* Видим, что мы зашли в testOne под root.

![5.jpg](..%2F..%2F..%2FDesktop%2FContainers2%2F5.jpg)

* Вводим следующую команду для просмотра выделенной и свободной памяти:


free -m![6.jpg](..%2F..%2F..%2FDesktop%2FContainers2%2F6.jpg)

#### Для удобства сразу перейдем в нужную папку:

cd sys/fs/cgroup

* Считываем данные из файла, в котором уграничивается потребление памяти контейнером:

cat memory.max
* Здесь мы можем наблюдать, что ограничение памяти установлено на максимальное значение.![7.jpg](..%2F..%2F..%2FDesktop%2FContainers2%2F7.jpg)

* Далее выполним тоже самое из папки .lxc:

* Убеждаемся в максимальном значении. Выходим из контейнера:

exit
* Для того, что бы ограничить потребление памяти контейнером, необходимо добавить строку в файл конфигурации. Для начала считаем информацию из него и убедимся, что ограничений там нет командой:

sudo cat /var/lib/lxc/testOne/config![8.jpg](..%2F..%2F..%2FDesktop%2FContainers2%2F8.jpg)

* После этого любым удобным редактором (я делал через редактор nano) добавляем в этот файл конфигурации вниз текста следующую строку:

lxc.cgroup2.memory.max = 256M![9.jpg](..%2F..%2F..%2FDesktop%2FContainers2%2F9.jpg)

* Таким образом мы ограничили потребление памяти на более 256 мб. Останавливаем контейнер и снова запускаем его. Вводим следующую команду, что бы убедиться, что ограничение работает:

sudo cat /sys/fs/cgroup/lxc.payload.testOne/mempry.max

#### Далее просмотрим список имеющихся в нашей системе контейнеров:
sudo lxc-ls -f
* У нас имеется один контейнер testOne, он запущен и в автозапуске стоит 0 (что означает, что автозапуск контейнера отключен). Нам необходимо включить автозапуск, для этого октрываем файл конфигурации в редакторе nano:

sudo nano /var/lib/lxc/testOne/config

![11-1.jpg](..%2F..%2F..%2FDesktop%2FContainers2%2F11-1.jpg)

* Добавляем в конец текста файла конфигурации следующую строку:

lxc.start.auto = 1


![12.jpg](..%2F..%2F..%2FDesktop%2FContainers2%2F12.jpg)

* Сохраняем, закрываем редактор и перезагружаем систему, например командой '$ reboot'.

* После перезагрузки снова выполняем команду:

sudo lxc-ls -f
* Вводим пароль root и убеждаемся, что контейнер запущен и автозапуск включен.
* ![13.jpg](..%2F..%2F..%2FDesktop%2FContainers2%2F13.jpg)


* При запуске контейнера можно в параметрах команды указать, где хранить логи, например:
lxc-start -n testOne --logfile log.log
* Для удаления контейнера необходмио воспользоваться следующей командой:
lxc-destroy -n testOne